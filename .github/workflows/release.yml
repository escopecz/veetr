name: Build and Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # Triggers on semver tags like 0.0.1, 1.2.3, etc.
      - '[0-9]+.[0-9]+.[0-9]+-*'  # Also includes pre-release tags like 1.0.0-beta.1

jobs:
  validate-build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract version from tag
      id: version
      run: |
        VERSION=${{ github.ref_name }}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "🏷️ Processing release for version: $VERSION"
    
    - name: Validate version consistency
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        echo "🔍 Validating version consistency across all files..."
        
        # Check root package.json
        ROOT_VERSION=$(node -e "console.log(require('./package.json').version)")
        echo "Root package.json version: $ROOT_VERSION"
        
        # Check web package.json
        WEB_VERSION=$(node -e "console.log(require('./web/package.json').version)")
        echo "Web package.json version: $WEB_VERSION"
        
        # Check TypeScript version file
        TS_VERSION=$(grep "const VERSION = " web/src/utils/version.ts | sed "s/.*const VERSION = '\\(.*\\)'.*/\\1/")
        echo "TypeScript version.ts version: $TS_VERSION"
        
        # Check firmware version
        FW_VERSION=$(grep "#define FIRMWARE_VERSION" firmware/src/main.cpp | sed 's/.*"\(.*\)".*/\1/')
        echo "Firmware main.cpp version: $FW_VERSION"
        
        # Validate all versions match the tag
        ERRORS=0
        
        if [ "$ROOT_VERSION" != "$VERSION" ]; then
          echo "❌ Root package.json version ($ROOT_VERSION) doesn't match tag ($VERSION)"
          ERRORS=$((ERRORS + 1))
        fi
        
        if [ "$WEB_VERSION" != "$VERSION" ]; then
          echo "❌ Web package.json version ($WEB_VERSION) doesn't match tag ($VERSION)"
          ERRORS=$((ERRORS + 1))
        fi
        
        if [ "$TS_VERSION" != "$VERSION" ]; then
          echo "❌ TypeScript version ($TS_VERSION) doesn't match tag ($VERSION)"
          ERRORS=$((ERRORS + 1))
        fi
        
        if [ "$FW_VERSION" != "$VERSION" ]; then
          echo "❌ Firmware version ($FW_VERSION) doesn't match tag ($VERSION)"
          ERRORS=$((ERRORS + 1))
        fi
        
        if [ $ERRORS -eq 0 ]; then
          echo "✅ All versions are consistent with tag $VERSION"
        else
          echo "❌ Found $ERRORS version inconsistencies"
          exit 1
        fi
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install web dependencies and build
      run: |
        echo "📦 Installing web dependencies..."
        cd web && npm install
        echo "🏗️ Building web application..."
        npm run build
    
    - name: Setup Python for PlatformIO
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio/.cache
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
    
    - name: Install PlatformIO
      run: |
        echo "⚡ Installing PlatformIO..."
        python -m pip install --upgrade pip
        pip install platformio
    
    - name: Build firmware
      run: |
        echo "🔧 Building firmware..."
        pio run --environment esp32dev
    
    - name: Prepare firmware artifacts
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        mkdir -p release-artifacts
        cp .pio/build/esp32dev/firmware.bin release-artifacts/veetr-$VERSION.bin
        cp .pio/build/esp32dev/firmware.elf release-artifacts/veetr-$VERSION.elf
        # Create firmware info file
        cat > release-artifacts/firmware-info.json << EOF
        {
          "version": "$VERSION",
          "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "binary_size": $(stat -c%s release-artifacts/veetr-$VERSION.bin),
          "target": "esp32dev"
        }
        EOF
        echo "📦 Prepared artifacts:"
        ls -la release-artifacts/
    
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ steps.version.outputs.version }}
        path: release-artifacts/
        retention-days: 90
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        # Get commit messages since last tag
        LAST_TAG=$(git tag --sort=-version:refname | grep -v "^$VERSION$" | head -1)
        if [ -z "$LAST_TAG" ]; then
          LAST_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "📝 Generating changelog from $LAST_TAG to $VERSION"
        
        # Extract changes by category
        FEATURES=$(git log --oneline $LAST_TAG..HEAD --grep="feat\|add\|implement" --pretty="- %s" | head -10)
        FIXES=$(git log --oneline $LAST_TAG..HEAD --grep="fix\|bug" --pretty="- %s" | head -10)
        IMPROVEMENTS=$(git log --oneline $LAST_TAG..HEAD --grep="improve\|enhance\|update\|refactor" --pretty="- %s" | head -10)
        
        # Get firmware size info
        FIRMWARE_SIZE=$(stat -c%s release-artifacts/veetr-$VERSION.bin)
        FIRMWARE_SIZE_KB=$((FIRMWARE_SIZE / 1024))
        
        # Get build info
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
        COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
        
        cat > release-notes.md << EOF
        # Veetr $VERSION
        
        Built on $BUILD_DATE from commit [\`$COMMIT_SHORT\`](https://github.com/escopecz/veetr/commit/${{ github.sha }})
        
        ## 🆕 New Features
        
        $FEATURES
        
        ## 🐛 Bug Fixes
        
        $FIXES
        
        ## ⚡ Improvements
        
        $IMPROVEMENTS
        
        ## 📦 Downloads
        
        - **Firmware Binary**: \`veetr-$VERSION.bin\` (${FIRMWARE_SIZE_KB} KB) - Flash this to your ESP32
        - **Debug Symbols**: \`veetr-$VERSION.elf\` - For debugging crashes and development (contains source code mapping)
        - **Build Info**: \`firmware-info.json\` - Technical build details and metadata
        - **Web Dashboard**: https://app.veetr.org (always latest)
        
        ## 🔄 How to Update
        
        **📖 [Complete Firmware Update Guide](https://github.com/escopecz/veetr/blob/main/docs/FIRMWARE_UPDATE.md)**
        
        **Quick Update**: Use the web dashboard → Settings → Firmware Update → "Check for Updates"
        
        **Manual Install**: \`esptool.py write_flash 0x10000 veetr-$VERSION.bin\`
        
        ## 🔧 Technical Details
        - **Firmware Size**: ${FIRMWARE_SIZE_KB} KB (${FIRMWARE_SIZE} bytes)
        - **Target**: ESP32 DOIT DevKit v1
        - **Build Date**: $BUILD_DATE
        - **Commit**: [\`$COMMIT_SHORT\`](https://github.com/escopecz/veetr/commit/${{ github.sha }})
        
        ---
        
        **Full Changelog**: https://github.com/escopecz/veetr/compare/$LAST_TAG...$VERSION
        EOF
        
        echo "✅ Generated release notes for $VERSION"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Veetr ${{ steps.version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        files: |
          release-artifacts/veetr-${{ steps.version.outputs.version }}.bin
          release-artifacts/veetr-${{ steps.version.outputs.version }}.elf
          release-artifacts/firmware-info.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Release Summary
      run: |
        echo "🎉 Release pipeline completed successfully!"
        echo "📋 Summary:"
        echo "   ✅ Version ${{ steps.version.outputs.version }} validated"
        echo "   ✅ Web and firmware builds successful"
        echo "   ✅ GitHub Release published"
        echo ""
        echo "🔗 Release: https://github.com/escopecz/veetr/releases/tag/${{ steps.version.outputs.version }}"
